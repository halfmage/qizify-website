---
import Button from './Button.astro';

interface Props {
	currentLang: 'en' | 'de';
}

const { currentLang } = Astro.props;

// Consent text based on language
const consentText = {
	en: {
		privacyLink: '/privacy',
		termsLink: '/terms',
	},
	de: {
		privacyLink: '/de/privacy',
		termsLink: '/de/terms',
	},
};

const consent = consentText[currentLang];
---

<!-- Hidden HTML form for Netlify Forms detection -->
<form name="demo-request" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="hidden">
	<input type="hidden" name="form-name" value="demo-request" />
	<input type="text" name="name" />
	<input type="text" name="company" />
	<input type="email" name="email" />
	<textarea name="message"></textarea>
	<input type="checkbox" name="consent" />
	<input type="text" name="bot-field" />
</form>

<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] opacity-0 invisible transition-all duration-300 p-4" id="demo-request-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true" data-lang={currentLang}>
	<div class="bg-dark border border-gray rounded-2xl max-w-[600px] w-full max-h-[90vh] overflow-y-auto relative scale-95 transition-transform duration-300" id="modal-container">
		<button class="absolute top-4 right-4 bg-transparent border-none text-white cursor-pointer p-2 flex items-center justify-center rounded-lg hover:bg-gray/50 transition-colors duration-200 z-10" id="modal-close" aria-label="Close modal">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
		</button>
		
		<div class="p-6 md:p-10">
			<h2 class="text-2xl md:text-3xl font-bold text-white m-0 mb-6 md:mb-8 text-center" id="modal-title">
				{currentLang === 'en' ? 'Request Demo' : 'Demo anfordern'}
			</h2>
			
			<form class="flex flex-col gap-5 md:gap-6" id="demo-form" method="POST" data-netlify="true" netlify-honeypot="bot-field">
				<input type="hidden" name="form-name" value="demo-request" />
				
				<!-- Honeypot field for spam protection -->
				<input type="text" name="bot-field" class="hidden" />
				
				<div class="flex flex-col gap-2">
					<label for="name" class="text-[0.9375rem] font-medium text-white">
						{currentLang === 'en' ? 'Name' : 'Name'}
						<span class="text-primary ml-1">*</span>
					</label>
					<input 
						type="text" 
						id="name" 
						name="name" 
						class="bg-gray/30 border border-gray rounded-lg px-4 py-3 text-base text-white font-sans w-full focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200 placeholder:text-white/40" 
						required 
						aria-required="true"
					/>
				</div>
				
				<div class="flex flex-col gap-2">
					<label for="company" class="text-[0.9375rem] font-medium text-white">
						{currentLang === 'en' ? 'Company' : 'Unternehmen'}
						<span class="text-primary ml-1">*</span>
					</label>
					<input 
						type="text" 
						id="company" 
						name="company" 
						class="bg-gray/30 border border-gray rounded-lg px-4 py-3 text-base text-white font-sans w-full focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200 placeholder:text-white/40" 
						required 
						aria-required="true"
					/>
				</div>
				
				<div class="flex flex-col gap-2">
					<label for="email" class="text-[0.9375rem] font-medium text-white">
						{currentLang === 'en' ? 'Email' : 'E-Mail'}
						<span class="text-primary ml-1">*</span>
					</label>
					<input 
						type="email" 
						id="email" 
						name="email" 
						class="bg-gray/30 border border-gray rounded-lg px-4 py-3 text-base text-white font-sans w-full focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200 placeholder:text-white/40" 
						required 
						aria-required="true"
					/>
				</div>
				
				<div class="flex flex-col gap-2">
					<label for="message" class="text-[0.9375rem] font-medium text-white">
						{currentLang === 'en' ? 'Message' : 'Nachricht'}
						<span class="text-primary ml-1">*</span>
					</label>
					<textarea 
						id="message" 
						name="message" 
						class="bg-gray/30 border border-gray rounded-lg px-4 py-3 text-base text-white font-sans w-full min-h-[100px] resize-y focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-200 placeholder:text-white/40" 
						rows="4" 
						required 
						aria-required="true"
					></textarea>
				</div>
				
				<div class="flex items-start gap-3">
					<label class="flex items-start gap-3 cursor-pointer text-sm text-white/90 leading-relaxed">
						<input 
							type="checkbox" 
							id="consent" 
							name="consent" 
							class="mt-1 w-[18px] h-[18px] flex-shrink-0 cursor-pointer accent-primary" 
							required 
							aria-required="true"
						/>
						<span class="flex-1">
							{currentLang === 'en' ? (
								<>
									I agree to the <a href={consent.privacyLink} target="_blank" rel="noopener noreferrer" class="text-primary underline hover:opacity-80 transition-opacity duration-200">Privacy Policy</a> and <a href={consent.termsLink} target="_blank" rel="noopener noreferrer" class="text-primary underline hover:opacity-80 transition-opacity duration-200">Terms of Use</a>. I consent to be contacted by LearnSlice via email. I agree to the storage of my transmitted data for the required time.
								</>
							) : (
								<>
									Ich stimme der <a href={consent.privacyLink} target="_blank" rel="noopener noreferrer" class="text-primary underline hover:opacity-80 transition-opacity duration-200">Datenschutzerklärung</a> und den <a href={consent.termsLink} target="_blank" rel="noopener noreferrer" class="text-primary underline hover:opacity-80 transition-opacity duration-200">Nutzungsbedingungen</a> zu. Ich stimme zu, dass LearnSlice mich per E-Mail kontaktieren darf. Ich stimme der Speicherung meiner übermittelten Daten für die erforderliche Zeit zu.
								</>
							)}
							<span class="text-primary ml-1">*</span>
						</span>
					</label>
				</div>
				
				<div class="hidden p-4 rounded-lg text-[0.9375rem] leading-relaxed bg-red-500/10 border border-red-500/30 text-red-300" id="form-error" role="alert"></div>
				<div class="hidden p-4 rounded-lg text-[0.9375rem] leading-relaxed bg-green-500/10 border border-green-500/30 text-green-300" id="form-success" role="alert">
					{currentLang === 'en' 
						? 'Thank you! We will contact you soon.' 
						: 'Vielen Dank! Wir werden uns bald bei Ihnen melden.'}
				</div>
				
				<button type="submit" class="bg-primary text-white border-none rounded-lg px-8 py-4 text-base font-semibold cursor-pointer hover:bg-[#5554d1] hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200 font-sans mt-2 disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none">
					{currentLang === 'en' ? 'Send' : 'Senden'}
				</button>
			</form>
		</div>
	</div>
</div>

<script>
	// Modal functionality
	function initDemoModal() {
		const modal = document.getElementById('demo-request-modal');
		const modalContainer = document.getElementById('modal-container');
		const closeButton = document.getElementById('modal-close');
		const form = document.getElementById('demo-form') as HTMLFormElement | null;
		const errorMessage = document.getElementById('form-error');
		const successMessage = document.getElementById('form-success');
		
		if (!modal || !closeButton || !form) return;
		
		// Open modal when clicking links with #demo-request hash
		function openModal() {
			modal?.setAttribute('aria-hidden', 'false');
			modal?.classList.remove('opacity-0', 'invisible');
			modal?.classList.add('opacity-100', 'visible');
			modalContainer?.classList.remove('scale-95');
			modalContainer?.classList.add('scale-100');
			document.body.style.overflow = 'hidden';
			// Focus first input
			const firstInput = form?.querySelector('input, textarea') as HTMLElement | null;
			if (firstInput) {
				setTimeout(() => firstInput.focus(), 100);
			}
		}
		
		// Close modal
		function closeModal() {
			modal?.setAttribute('aria-hidden', 'true');
			modal?.classList.add('opacity-0', 'invisible');
			modal?.classList.remove('opacity-100', 'visible');
			modalContainer?.classList.add('scale-95');
			modalContainer?.classList.remove('scale-100');
			document.body.style.overflow = '';
			// Reset form
			form?.reset();
			if (errorMessage) errorMessage.classList.add('hidden');
			if (successMessage) successMessage.classList.add('hidden');
		}
		
		// Handle hash changes
		function handleHashChange() {
			if (window.location.hash === '#demo-request') {
				openModal();
			} else {
				closeModal();
			}
		}
		
		// Initial check
		handleHashChange();
		
		// Listen for hash changes
		window.addEventListener('hashchange', handleHashChange);
		
		// Handle clicks on modal trigger buttons
		document.querySelectorAll('[data-modal-trigger="demo-request"]').forEach((trigger) => {
			trigger.addEventListener('click', (e) => {
				e.preventDefault();
				window.location.hash = 'demo-request';
			});
		});
		
		// Close button
		closeButton.addEventListener('click', () => {
			window.location.hash = '';
			closeModal();
		});
		
		// Close on overlay click
		modal.addEventListener('click', (e) => {
			if (e.target === modal) {
				window.location.hash = '';
				closeModal();
			}
		});
		
		// Close on Escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && !modal.classList.contains('invisible')) {
				window.location.hash = '';
				closeModal();
			}
		});
		
		// Form submission
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			// Hide previous messages
			if (errorMessage) errorMessage.classList.add('hidden');
			if (successMessage) successMessage.classList.add('hidden');
			
			// Get form data
			const formData = new FormData(form);
			
			// Submit via AJAX
			try {
				const response = await fetch('/', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: new URLSearchParams(formData as any).toString(),
				});
				
				if (response.ok) {
					// Show success message
					if (successMessage) successMessage.classList.remove('hidden');
					form.reset();
					
					// Close modal after 2 seconds
					setTimeout(() => {
						window.location.hash = '';
						closeModal();
					}, 2000);
				} else {
					throw new Error('Form submission failed');
				}
			} catch (error) {
				// Show error message
				const lang = modal.getAttribute('data-lang') || 'en';
				if (errorMessage) {
					errorMessage.textContent = lang === 'en' 
						? 'An error occurred. Please try again or contact us directly.' 
						: 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt.';
					errorMessage.classList.remove('hidden');
				}
			}
		});
	}
	
	// Initialize when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initDemoModal);
	} else {
		initDemoModal();
	}
</script>
